<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SDLC AI</title>

<style>
body { font-family: Arial; margin: 40px; max-width: 900px; }
textarea { width: 100%; height: 80px; }

.step { padding: 10px; margin: 8px 0; border-radius: 6px; }
.pending { background:#eee; }
.running { background:#fff3cd; }
.completed { background:#d4edda; }
.failed { background:#f8d7da; }

.step-header {
  display:flex;
  justify-content:space-between;
  cursor:pointer;
  font-weight:bold;
}

.step-body {
  display:none;
  background:#111;
  color:#0f0;
  padding:10px;
  margin-top:8px;
  border-radius:4px;
}

.step-body textarea {
  width:100%;
  min-height:220px;
  background:#000;
  color:#0f0;
  border:1px solid #444;
  font-family:monospace;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>SDLC AI</h1>

<textarea id="idea"></textarea><br><br>
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="status">Idle</div>

<h3>Workflow Progress</h3>
<div id="steps"></div>

<script>
const API = "/api/workflows";
let jobId = null;
let poller = null;

const stepCache = {};
const stepExpanded = {};

const LABELS = {
  intake:"Problem Statement",
  scope:"Scope Definition",
  requirements:"Requirements Breakdown",
  architecture:"Architecture Design",
  estimation:"Effort Estimation",
  risk:"Risk Analysis",
  sow:"Statement of Work"
};

function startJob() {
  fetch(`${API}/start`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ product_idea: idea.value })
  })
  .then(r=>r.json())
  .then(d=>{
    jobId = d.job_id;
    poller && clearInterval(poller);
    poller = setInterval(fetchStatus,3000);
  });
}

function fetchStatus() {
  fetch(`${API}/${jobId}/status`)
    .then(r=>r.json())
    .then(render);
}

function render(data) {
  status.innerText =
    data.current_step === "completed"
      ? "Workflow completed ✅"
      : `Current step: ${LABELS[data.current_step]}`;

  const stepsDiv = document.getElementById("steps");
  stepsDiv.innerHTML = "";

  Object.entries(data.steps).forEach(([step, state]) => {
    const div = document.createElement("div");
    div.className = `step ${state}`;

    const header = document.createElement("div");
    header.className = "step-header";
    header.innerHTML = `<span>${LABELS[step]}</span><span>${state}</span>`;

    const body = document.createElement("div");
    body.className = "step-body";

    header.onclick = () => {
      if (state !== "completed" && state !== "failed") return;

      stepExpanded[step] = !stepExpanded[step];
      body.style.display = stepExpanded[step] ? "block" : "none";

      if (stepExpanded[step] && !stepCache[step]) {
        fetch(`${API}/${jobId}/steps/${step}`)
          .then(r=>r.json())
          .then(d=>{
            stepCache[step] = d;
            renderBody(step, body);
          });
      } else if (stepExpanded[step]) {
        renderBody(step, body);
      }
    };

    div.appendChild(header);
    div.appendChild(body);
    stepsDiv.appendChild(div);
  });
}

function renderBody(step, body) {
  const d = stepCache[step];
  const text = d.output?.raw_output
    ? d.output.raw_output.replace(/\\n/g,"\n")
    : "No output";

  body.innerHTML = `
    <div>Status: ${d.status}</div>
    <div>Started: ${d.started_at ?? "—"}</div>
    <div>Completed: ${d.completed_at ?? "—"}</div>
    <br>
    <textarea readonly>${text}</textarea>
  `;
}
</script>

</body>
</html>
