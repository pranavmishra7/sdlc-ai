<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea {
      width: 100%;
      height: 80px;
      padding: 8px;
      font-size: 14px;
    }

    button {
      padding: 8px 14px;
      margin-top: 10px;
      cursor: pointer;
    }

    .step {
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    .time {
      font-size: 12px;
      opacity: 0.8;
    }

    pre {
      background: #111;
      color: #0f0;
      padding: 12px;
      overflow-x: auto;
      font-size: 13px;
    }

    h3 {
      margin-top: 30px;
    }
  </style>
</head>

<body>

<h1>SDLC AI</h1>

<h3>Product Idea</h3>
<textarea id="idea" placeholder="Describe your product idea..."></textarea>
<br />
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="status">Idle</div>

<h3>Workflow Progress</h3>
<div id="steps"></div>

<h3>Actions</h3>
<button onclick="resumeJob()">Resume Job</button>

<h3>Result</h3>
<pre id="result"></pre>

<script>
let jobId = null;
let poller = null;

/* ðŸ”¹ User-friendly labels */
const STEP_LABELS = {
  intake: "Problem Statement",
  scope: "Scope Definition",
  requirements: "Requirements Breakdown",
  architecture: "Architecture Design",
  estimation: "Effort Estimation",
  risk: "Risk Analysis",
  sow: "Statement of Work"
};

function startJob() {
  const idea = document.getElementById("idea").value;

  fetch(`/v1/start?product_idea=${encodeURIComponent(idea)}`, {
    method: "POST"
  })
    .then(r => r.json())
    .then(data => {
      jobId = data.job_id;
      document.getElementById("status").innerText =
        `Job started (ID: ${jobId})`;
      startPolling();
    });
}

function startPolling() {
  if (poller) clearInterval(poller);
  poller = setInterval(fetchStatus, 2000);
}

function fetchStatus() {
  if (!jobId) return;

  fetch(`/v1/status/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("status").innerText =
        `Status: ${data.status} | Current step: ${STEP_LABELS[data.current_step] ?? data.current_step}`;

      const stepsDiv = document.getElementById("steps");
      stepsDiv.innerHTML = "";

      for (const [step, state] of Object.entries(data.steps)) {
        const div = document.createElement("div");
        div.className = `step ${state}`;

        const label = STEP_LABELS[step] ?? step;

        div.innerHTML = `
          <strong>${label}</strong>
          <span class="time">${state}</span>
        `;

        stepsDiv.appendChild(div);
      }

      if (data.status === "completed") {
        clearInterval(poller);
        fetchResult();
      }

      if (data.status === "failed") {
        clearInterval(poller);
        document.getElementById("status").innerText =
          `âŒ Failed at ${STEP_LABELS[data.current_step]}`;
      }
    });
}

function fetchResult() {
  fetch(`/v1/result/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("result").innerText =
        JSON.stringify(data, null, 2);
    });
}

function resumeJob() {
  if (!jobId) return;

  fetch(`/v1/resume/${jobId}`, { method: "POST" })
    .then(() => startPolling());
}
</script>

</body>
</html>
