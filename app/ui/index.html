<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 1000px;
      background: #fafafa;
    }

    textarea,
    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .step {
      margin: 14px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .pending {
      background: #f5f5f5;
    }

    .running {
      background: #fff3cd;
    }

    .completed {
      background: #e8f5e9;
    }

    .header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      font-weight: bold;
    }

    .body {
      display: none;
      margin-top: 12px;
      padding: 14px;
      background: #111;
      color: #ddd;
      border-radius: 4px;
    }

    .section {
      margin-top: 16px;
    }

    .section-title {
      color: #9cdcfe;
      font-weight: bold;
      margin-bottom: 6px;
    }

    ul {
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
    }

    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h2>SDLC AI â€“ Client Documentation Generator</h2>

  <!-- ================= LOGIN ================= -->

  <div id="loginBox">
    <h3>Login</h3>
    <input id="username" placeholder="Username / Email" />
    <input id="password" type="password" placeholder="Password" />
    <br><br>
    <button onclick="login()">Login</button>
    <div id="loginError" class="error"></div>
  </div>

  <!-- ================= APP ================= -->

  <div id="app" class="hidden">

    <div class="section">
      <div class="section-title">Product Idea</div>
      <textarea id="product_idea" rows="3">
Create structured, client-facing documentation for a financial investment solutions application.
    </textarea>
    </div>

    <div class="section">
      <div class="section-title">Domain</div>
      <input id="domain" value="Financial Services â€“ Investment Products and Portfolio Management" />
    </div>

    <div class="section">
      <div class="section-title">Primary Audience (one per line)</div>
      <textarea id="audience_primary" rows="4">
Retail investors
Relationship managers
    </textarea>
    </div>

    <div class="section">
      <div class="section-title">Secondary Audience (one per line)</div>
      <textarea id="audience_secondary" rows="3">
Compliance teams
Operations teams
    </textarea>
    </div>

    <div class="section">
      <div class="section-title">Documentation Objective</div>
      <textarea id="objective" rows="3">
Provide clear, accurate, regulator-safe documentation without offering financial advice.
    </textarea>
    </div>

    <div class="section">
      <div class="section-title">Regulatory Constraints (one per line)</div>
      <textarea id="regulatory" rows="3">
No financial advice
No performance guarantees
Regulated financial environment
    </textarea>
    </div>

    <br>
    <button onclick="startJob()">Start SDLC Job</button>

    <h3>Status</h3>
    <div id="status">Idle</div>

    <h3>Workflow</h3>
    <div id="steps"></div>
  </div>

  <script>
    /* ================= CONFIG ================= */

    const WORKFLOW_API = "/api/v1/api/workflows/workflows";
    const LOGIN_API = "/api/v1/auth/auth/login";

    let token = localStorage.getItem("access_token");
    let jobId = null;
    let poller = null;

    const created = {};
    const expanded = {};
    const cache = {};

    const LABELS = {
      intake: "Problem Definition",
      scope: "Scope",
      requirements: "Requirements",
      architecture: "Architecture",
      estimation: "Estimation",
      risk: "Risk",
      sow: "Statement of Work"
    };

    /* ================= AUTH ================= */

    if (token) showApp();

    function login() {
      const form = new URLSearchParams();
      form.append("grant_type", "password");
      form.append("username", username.value);
      form.append("password", password.value);

      fetch(LOGIN_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: form.toString()
      })
        .then(r => r.json())
        .then(d => {
          if (!d.access_token) {
            loginError.innerText = "Invalid credentials";
            return;
          }
          token = d.access_token;
          localStorage.setItem("access_token", token);
          showApp();
        });
    }

    function showApp() {
      loginBox.classList.add("hidden");
      app.classList.remove("hidden");
    }

    /* ================= FETCH ================= */

    function authFetch(url, options = {}) {
      return fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });
    }

    /* ================= START JOB ================= */

    function startJob() {
      if (poller) clearInterval(poller);

      const payload = {
        product_idea: product_idea.value,
        domain: domain.value,
        target_audience: {
          primary: audience_primary.value.split("\n").filter(Boolean),
          secondary: audience_secondary.value.split("\n").filter(Boolean)
        },
        documentation_objective: objective.value,
        regulatory_context: regulatory.value.split("\n").filter(Boolean)
      };

      status.innerText = "Starting workflowâ€¦";

      authFetch(`${WORKFLOW_API}/start`, {
        method: "POST",
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(d => {
          jobId = d.job_id;
          status.innerText = `Workflow started (${jobId})`;
          fetchStatus();                      // ðŸ”‘ immediate fetch
          poller = setInterval(fetchStatus, 3000);
        });
    }

    /* ================= STATUS ================= */

    function fetchStatus() {
      if (!jobId) return;

      authFetch(`${WORKFLOW_API}/${jobId}/status`)
        .then(r => r.json())
        .then(updateUI);
    }

    function updateUI(data) {
      if (!data || !data.current_step) return;

      status.innerText =
        data.current_step === "completed"
          ? "Workflow completed âœ…"
          : "Current step: " + (LABELS[data.current_step] || data.current_step);

      for (const step in data.steps) {
        if (!created[step]) createStep(step);
        updateStep(step, data.steps[step]);
      }

      if (data.current_step === "completed" && poller) {
        clearInterval(poller);
        poller = null;
      }
    }

    /* ================= STEPS ================= */

    function createStep(step) {
      const box = document.createElement("div");
      box.id = `step-${step}`;
      box.className = "step pending";

      const header = document.createElement("div");
      header.className = "header";
      header.innerHTML = `<span>${LABELS[step] || step}</span><span id="state-${step}"></span>`;

      const body = document.createElement("div");
      body.id = `body-${step}`;
      body.className = "body";

      header.onclick = () => {
        expanded[step] = !expanded[step];
        body.style.display = expanded[step] ? "block" : "none";
        if (expanded[step] && !cache[step]) fetchStep(step);
      };

      box.appendChild(header);
      box.appendChild(body);
      steps.appendChild(box);
      created[step] = true;
    }

    function updateStep(step, state) {
      document.getElementById(`step-${step}`).className = `step ${state}`;
      document.getElementById(`state-${step}`).innerText = state;
    }

    function fetchStep(step) {
      authFetch(`${WORKFLOW_API}/${jobId}/steps/${step}`)
        .then(r => r.json())
        .then(res => {
          cache[step] = res;
          renderStep(step);
        });
    }

    function renderStep(step) {
      const body = document.getElementById(`body-${step}`);
      const parsed = cache[step]?.data?.parsed;   // âœ… correct key
      body.innerHTML = parsed ? renderAny(parsed) : "<div>No output</div>";
    }

    /* ================= GENERIC RENDER ================= */

    function renderAny(value) {
      if (Array.isArray(value)) {
        return `<ul>${value.map(v => `<li>${renderAny(v)}</li>`).join("")}</ul>`;
      }
      if (typeof value === "object" && value !== null) {
        return Object.entries(value)
          .map(([k, v]) => `
        <div class="section">
          <div class="section-title">${toTitle(k)}</div>
          ${renderAny(v)}
        </div>
      `).join("");
      }
      return `<p>${value}</p>`;
    }

    function toTitle(text) {
      return text.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }
  </script>

</body>

</html>