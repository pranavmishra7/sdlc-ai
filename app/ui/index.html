<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea#idea-input {
      width: 100%;
      height: 80px;
      padding: 8px;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-left: 6px;
    }

    .step {
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    .step-body {
      display: none;
      margin-top: 8px;
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
    }

    .step-body label {
      display: block;
      margin-top: 6px;
      font-weight: bold;
      color: #9cdcfe;
    }

    .step-body textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      background: #000;
      color: #0f0;
      border: 1px solid #444;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h1>SDLC AI</h1>

<textarea id="idea-input" placeholder="Describe your product idea..."></textarea>
<br><br>
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="job-status">Idle</div>

<h3>Workflow Progress</h3>
<div id="steps-container"></div>

<script>
let jobId = null;
let poller = null;
let evtSource = null;

const stepOutputCache = {};
const stepExpanded = {};
const stepElements = {};

const API = "/api/workflows";

const STEP_LABELS = {
  intake: "Problem Statement",
  scope: "Scope Definition",
  requirements: "Requirements Breakdown",
  architecture: "Architecture Design",
  estimation: "Effort Estimation",
  risk: "Risk Analysis",
  sow: "Statement of Work"
};

function startJob() {
  const idea = document.getElementById("idea-input").value.trim();
  if (!idea) return alert("Enter product idea");

  fetch(`${API}/start`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({product_idea: idea})
  })
  .then(r => r.json())
  .then(d => {
    jobId = d.job_id;
    document.getElementById("job-status").innerText = "Job started";
    startPolling();
    attachSSE();
  });
}

function startPolling() {
  poller && clearInterval(poller);
  poller = setInterval(fetchStatus, 3000);
}

function fetchStatus() {
  fetch(`${API}/${jobId}/status`)
    .then(r => r.json())
    .then(updateUI);
}

function updateUI(data) {
  document.getElementById("job-status").innerText =
    data.current_step === "completed"
      ? "Workflow completed ✅"
      : `Current step: ${STEP_LABELS[data.current_step]}`;

  Object.entries(data.steps).forEach(([step, state]) => {
    if (!stepElements[step]) {
      createStep(step, state);
    } else {
      stepElements[step].className = `step ${state}`;
    }
  });
}

function createStep(step, state) {
  const container = document.getElementById("steps-container");

  const stepDiv = document.createElement("div");
  stepDiv.className = `step ${state}`;

  const header = document.createElement("div");
  header.className = "step-header";
  header.innerHTML = `<strong>${STEP_LABELS[step]}</strong><span>${state}</span>`;

  const body = document.createElement("div");
  body.className = "step-body";

  header.onclick = () => {
    stepExpanded[step] = !stepExpanded[step];
    body.style.display = stepExpanded[step] ? "block" : "none";

    if (stepExpanded[step] && !stepOutputCache[step]) {
      fetch(`${API}/${jobId}/steps/${step}`)
        .then(r => r.json())
        .then(d => {
          stepOutputCache[step] = d;
          renderStepOutput(step, body);
        });
    } else if (stepExpanded[step]) {
      renderStepOutput(step, body);
    }
  };

  stepDiv.appendChild(header);
  stepDiv.appendChild(body);
  container.appendChild(stepDiv);

  stepElements[step] = stepDiv;
}

function renderStepOutput(step, body) {
  const d = stepOutputCache[step];
  if (!d) return;

  const text = d.output?.raw_output
    ? d.output.raw_output.replace(/\\n/g, "\n")
    : "No output";

  body.innerHTML = `
    <label>Status:</label> ${d.status}
    <label>Started:</label> ${d.started_at ?? "—"}
    <label>Completed:</label> ${d.completed_at ?? "—"}
    <label>Output:</label>
    <textarea readonly>${text}</textarea>
  `;
}

function attachSSE() {
  evtSource && evtSource.close();
  evtSource = new EventSource(`${API}/events/${jobId}`);
  evtSource.onmessage = fetchStatus;
}
</script>

</body>
</html>
