<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 1000px;
      background: #fafafa;
    }

    h2, h3 {
      margin-top: 30px;
    }

    textarea, input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
    }

    .hidden { display: none; }

    .step {
      margin: 14px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .pending { background: #f5f5f5; }
    .running { background: #fff3cd; }
    .completed { background: #e8f5e9; }

    .header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      font-weight: bold;
    }

    .body {
      display: none;
      margin-top: 12px;
      padding: 14px;
      background: #111;
      color: #ddd;
      border-radius: 4px;
    }

    .section {
      margin-top: 16px;
    }

    .section-title {
      color: #9cdcfe;
      font-weight: bold;
      margin-bottom: 6px;
    }

    ul { padding-left: 20px; }
    li { margin-bottom: 6px; }

    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h2>SDLC AI – Client Documentation Generator</h2>

<!-- ================= LOGIN ================= -->

<div id="loginBox">
  <h3>Login</h3>
  <input id="username" placeholder="Username / Email" />
  <input id="password" type="password" placeholder="Password" />
  <br><br>
  <button onclick="login()">Login</button>
  <div id="loginError" class="error"></div>
</div>

<!-- ================= APP ================= -->

<div id="app" class="hidden">

  <!-- INPUT FORM -->

  <div class="section">
    <div class="section-title">Product Idea</div>
    <textarea id="product_idea" rows="4">
Create structured, client-facing documentation for a financial investment solutions application.
    </textarea>
  </div>

  <div class="section">
    <div class="section-title">Domain</div>
    <input id="domain" value="Financial Services – Investment Products" />
  </div>

  <div class="section">
    <div class="section-title">Primary Audience (one per line)</div>
    <textarea id="audience_primary" rows="3">
Retail investors
Relationship managers
    </textarea>
  </div>

  <div class="section">
    <div class="section-title">Secondary Audience (one per line)</div>
    <textarea id="audience_secondary" rows="3">
Compliance teams
Operations teams
    </textarea>
  </div>

  <div class="section">
    <div class="section-title">Documentation Objective</div>
    <textarea id="objective" rows="3">
Provide clear, regulator-safe documentation without offering financial advice.
    </textarea>
  </div>

  <div class="section">
    <div class="section-title">Regulatory Constraints (one per line)</div>
    <textarea id="regulatory" rows="3">
No financial advice
No performance guarantees
Regulated financial environment
    </textarea>
  </div>

  <br>
  <button onclick="startJob()">Start SDLC Job</button>

  <h3>Status</h3>
  <div id="status">Idle</div>

  <h3>Workflow</h3>
  <div id="steps"></div>
</div>

<script>
/* ================= CONFIG ================= */

const WORKFLOW_API = "/api/v1/api/workflows/workflows";
const LOGIN_API = "/api/v1/auth/auth/login";

let token = localStorage.getItem("access_token");
let jobId = null;
let poller = null;

const created = {};
const expanded = {};
const cache = {};

const LABELS = {
  intake: "Problem Definition",
  scope: "Scope Definition",
  requirements: "Requirements",
  architecture: "Architecture",
  estimation: "Effort & Timeline",
  risk: "Risk Analysis",
  sow: "Statement of Work"
};

/* ================= AUTH ================= */

if (token) showApp();

function login() {
  const formData = new URLSearchParams();
  formData.append("grant_type", "password");
  formData.append("username", username.value);
  formData.append("password", password.value);

  fetch(LOGIN_API, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "accept": "application/json"
    },
    body: formData.toString()
  })
    .then(r => r.json())
    .then(d => {
      if (!d.access_token) {
        loginError.innerText = "Invalid credentials";
        return;
      }

      token = d.access_token;
      localStorage.setItem("access_token", token);
      showApp();
    })
    .catch(() => {
      loginError.innerText = "Login failed";
    });
}

function showApp() {
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}

/* ================= FETCH WRAPPER ================= */

function authFetch(url, options = {}) {
  options.headers = {
    ...(options.headers || {}),
    "Authorization": `Bearer ${token}`,
    "Content-Type": "application/json"
  };

  return fetch(url, options).then(r => {
    if (r.status === 401) {
      alert("Session expired. Please login again.");
      localStorage.removeItem("access_token");
      location.reload();
    }
    return r;
  });
}

/* ================= START JOB ================= */

function startJob() {
  const payload = {
    product_idea: product_idea.value,
    domain: domain.value,
    target_audience: {
      primary: audience_primary.value.split("\n").filter(Boolean),
      secondary: audience_secondary.value.split("\n").filter(Boolean)
    },
    documentation_objective: objective.value,
    regulatory_context: regulatory.value.split("\n").filter(Boolean),
    output_format: {
      style: "Professional, enterprise client-ready"
    }
  };

  authFetch(`${WORKFLOW_API}/start`, {
    method: "POST",
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(d => {
      jobId = d.job_id;
      status.innerText = `Job started (${jobId})`;
      fetchStatus();
      poller = setInterval(fetchStatus, 3000);
    });
}

/* ================= STATUS ================= */

function fetchStatus() {
  authFetch(`${WORKFLOW_API}/${jobId}/status`)
    .then(r => r.json())
    .then(updateUI);
}

function updateUI(data) {
  status.innerText =
    data.current_step === "completed"
      ? "Workflow completed ✅"
      : "Current step: " + LABELS[data.current_step];

  for (const step in data.steps) {
    if (!created[step]) createStep(step);
    updateStep(step, data.steps[step]);
  }

  if (data.current_step === "completed" && poller) {
    clearInterval(poller);
    poller = null;
  }
}

/* ================= STEPS ================= */

function createStep(step) {
  const container = document.getElementById("steps");

  const box = document.createElement("div");
  box.id = `step-${step}`;
  box.className = "step pending";

  const header = document.createElement("div");
  header.className = "header";
  header.innerHTML = `<span>${LABELS[step]}</span><span id="state-${step}"></span>`;

  const body = document.createElement("div");
  body.id = `body-${step}`;
  body.className = "body";

  header.onclick = () => {
    expanded[step] = !expanded[step];
    body.style.display = expanded[step] ? "block" : "none";
    if (expanded[step] && !cache[step]) fetchStep(step);
  };

  box.appendChild(header);
  box.appendChild(body);
  container.appendChild(box);
  created[step] = true;
}

function updateStep(step, state) {
  document.getElementById(`step-${step}`).className = `step ${state}`;
  document.getElementById(`state-${step}`).innerText = state;
}

function fetchStep(step) {
  authFetch(`${WORKFLOW_API}/${jobId}/steps/${step}`)
    .then(r => r.json())
    .then(res => {
      cache[step] = res;
      renderStep(step);
    });
}

function renderStep(step) {
  const body = document.getElementById(`body-${step}`);
  const data = cache[step]?.data?.parsed_output; // ✅ FIX
  if (!data) {
    body.innerHTML = "<div>No output</div>";
    return;
  }
  body.innerHTML = renderParsed(step, data);
}

/* ================= RENDERERS ================= */

function renderParsed(step, d) {
  switch (step) {
    case "intake":
      return section("Business Problem", [d.problem_statement.overview])
        + section("Current Challenges", d.problem_statement.current_challenges)
        + section("Business Impact", d.problem_statement.business_impact);

    case "scope":
      return section("In Scope", d.in_scope)
        + section("Out of Scope", d.out_of_scope)
        + section("Success Criteria", d.success_criteria);

    case "requirements":
      return section("Functional Requirements", d.functional_requirements)
        + section("Non-Functional Requirements", d.non_functional_requirements)
        + section("Constraints", d.constraints);

    case "architecture":
      return section("Architecture Overview", [d.architecture_overview])
        + section("System Components", d.components)
        + section("Data Flow", d.data_flow);

    case "estimation":
      return section("Effort Breakdown", d.effort_breakdown)
        + section("Timeline", [d.timeline])
        + section("Assumptions", d.assumptions)
        + section("Risks", d.risks);

    case "risk":
      return section("Key Risks", d.risks)
        + section("Mitigation Strategies", d.mitigations);

    case "sow":
      return section("Deliverables", d.deliverables)
        + section("Milestones", d.milestones)
        + section("Payment Terms", [d.payment_terms]);

    default:
      return "<pre>" + JSON.stringify(d, null, 2) + "</pre>";
  }
}

function section(title, items) {
  if (!items || !items.length) return "";
  return `
    <div class="section">
      <div class="section-title">${title}</div>
      <ul>${items.map(i => `<li>${i}</li>`).join("")}</ul>
    </div>
  `;
}
</script>

</body>
</html>
