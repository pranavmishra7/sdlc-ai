<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    button {
      padding: 8px 14px;
      margin-top: 10px;
    }

    .step {
      padding: 8px;
      margin: 6px 0;
      border-radius: 4px;
      font-size: 14px;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>

<body>

<h1>SDLC AI</h1>

<h3>Product Idea</h3>
<textarea id="idea"></textarea>
<br />
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="status"></div>

<h3>Steps</h3>
<div id="steps"></div>

<h3>Result</h3>
<pre id="result"></pre>

<script>
let jobId = null;
let poller = null;

// ⏱️ Track timing per step
const stepTimings = {};

/* ---------------- UTIL ---------------- */

function formatTime(date) {
  return date.toLocaleString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
}

/* ---------------- START JOB ---------------- */

function startJob() {
  const idea = document.getElementById("idea").value;

  jobId = null;
  for (const k in stepTimings) delete stepTimings[k];

  document.getElementById("status").innerText = "";
  document.getElementById("steps").innerHTML = "";
  document.getElementById("result").innerText = "";

  fetch(`/v1/start?product_idea=${encodeURIComponent(idea)}`, {
    method: "POST"
  })
    .then(r => r.json())
    .then(data => {
      jobId = data.job_id;
      document.getElementById("status").innerText =
        "Job started: " + jobId;
      startPolling();
    });
}

/* ---------------- POLLING ---------------- */

function startPolling() {
  if (poller) clearInterval(poller);
  poller = setInterval(fetchStatus, 2000);
}

function fetchStatus() {
  if (!jobId) return;

  fetch(`/v1/status/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("status").innerText =
        `Status: ${data.status} | Current step: ${data.current_step}`;

      renderSteps(data.steps);

      if (data.status === "completed") {
        clearInterval(poller);
        fetchResult();
      }

      if (data.status === "failed") {
        clearInterval(poller);
      }
    });
}

/* ---------------- STEP RENDER ---------------- */

function renderSteps(steps) {
  const stepsDiv = document.getElementById("steps");
  stepsDiv.innerHTML = "";

  const now = new Date();

  for (const [step, state] of Object.entries(steps)) {
    // initialize timing record
    if (!stepTimings[step]) {
      stepTimings[step] = {
        startedAt: null,
        endedAt: null,
        lastState: null
      };
    }

    const timing = stepTimings[step];

    // detect transition to running
    if (state === "running" && !timing.startedAt) {
      timing.startedAt = now;
    }

    // detect terminal transition
    if (
      (state === "completed" || state === "failed") &&
      timing.startedAt &&
      !timing.endedAt
    ) {
      timing.endedAt = now;
    }

    timing.lastState = state;

    const div = document.createElement("div");
    div.className = `step ${state}`;

    let text = `${step}: ${state}`;

    if (timing.startedAt) {
      text += ` — started running at ${formatTime(timing.startedAt)}`;
    }

    if (timing.endedAt) {
      text += ` → ${state} at ${formatTime(timing.endedAt)}`;
    }

    div.innerText = text;
    stepsDiv.appendChild(div);
  }
}

/* ---------------- RESULT ---------------- */

function fetchResult() {
  fetch(`/v1/result/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("result").innerText =
        JSON.stringify(data, null, 2);
    });
}
</script>

</body>
</html>
