<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea#idea-input {
      width: 100%;
      height: 80px;
      padding: 8px;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-left: 6px;
    }

    .step {
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      font-size: 14px;
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    .meta {
      font-size: 12px;
      opacity: 0.8;
    }

    .step-body {
      display: none;
      margin-top: 8px;
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
    }

    .step-body label {
      display: block;
      margin-top: 6px;
      font-weight: bold;
      color: #9cdcfe;
    }

    .step-body textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      background: #000;
      color: #0f0;
      border: 1px solid #444;
      padding: 10px;
      font-family: monospace;
      font-size: 13px;
      margin-top: 6px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h1>SDLC AI</h1>

<h3>Product Idea</h3>
<textarea id="idea-input" placeholder="Describe your product idea..."></textarea>
<br />
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="job-status">Idle</div>

<h3>Workflow Progress</h3>
<div id="steps-container"></div>

<script>
/* ================= STATE ================= */

let jobId = null;
let poller = null;
let evtSource = null;

const stepOutputCache = {};
const stepExpanded = {};

const API = "/api/workflows";

const STEP_LABELS = {
  intake: "Problem Statement",
  scope: "Scope Definition",
  requirements: "Requirements Breakdown",
  architecture: "Architecture Design",
  estimation: "Effort Estimation",
  risk: "Risk Analysis",
  sow: "Statement of Work"
};

/* ================= JOB ================= */

function startJob() {
  const idea = document.getElementById("idea-input").value.trim();
  if (!idea) return alert("Please enter a product idea");

  fetch(`${API}/start`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ product_idea: idea })
  })
    .then(r => r.json())
    .then(data => {
      jobId = data.job_id;
      document.getElementById("job-status").innerText =
        `Job started (${jobId})`;

      Object.keys(stepOutputCache).forEach(k => delete stepOutputCache[k]);
      Object.keys(stepExpanded).forEach(k => delete stepExpanded[k]);

      startPolling();
      attachSSE();
    });
}

function startPolling() {
  if (poller) clearInterval(poller);
  poller = setInterval(fetchStatus, 3000);
}

function fetchStatus() {
  if (!jobId) return;
  fetch(`${API}/${jobId}/status`)
    .then(r => r.json())
    .then(renderStatus);
}

/* ================= RENDER ================= */

function renderStatus(data) {
  const container = document.getElementById("steps-container");
  container.innerHTML = "";

  if (data.current_step === "completed") {
    document.getElementById("job-status").innerText =
      "Workflow completed ✅";
    clearInterval(poller);
    poller = null;
    if (evtSource) evtSource.close();
  } else {
    document.getElementById("job-status").innerText =
      `Current step: ${STEP_LABELS[data.current_step] ?? data.current_step}`;
  }

  for (const [step, state] of Object.entries(data.steps)) {
    const stepDiv = document.createElement("div");
    stepDiv.id = `step-${step}`;
    stepDiv.className = `step ${state}`;

    const header = document.createElement("div");
    header.id = `step-header-${step}`;
    header.className = "step-header";
    header.innerHTML = `
      <strong>${STEP_LABELS[step]}</strong>
      <span class="meta">${state}</span>
    `;

    const body = document.createElement("div");
    body.id = `step-body-${step}`;
    body.className = "step-body";

    if (stepExpanded[step]) {
      body.style.display = "block";
      if (stepOutputCache[step]) {
        renderStepOutput(step);
      }
    }

    header.onclick = () => {
      stepExpanded[step] = !stepExpanded[step];
      body.style.display = stepExpanded[step] ? "block" : "none";

      if (stepExpanded[step]) {
        stepOutputCache[step]
          ? renderStepOutput(step)
          : fetchStep(step);
      }
    };

    stepDiv.appendChild(header);
    stepDiv.appendChild(body);
    container.appendChild(stepDiv);
  }
}

/* ================= STEP ================= */

function fetchStep(step) {
  fetch(`${API}/${jobId}/steps/${step}`)
    .then(r => r.json())
    .then(data => {
      stepOutputCache[step] = data;
      renderStepOutput(step);
    });
}

function renderStepOutput(step) {
  const data = stepOutputCache[step];
  const body = document.getElementById(`step-body-${step}`);
  if (!data || !body) return;

  const started = data.started_at
    ? new Date(data.started_at).toLocaleString()
    : "—";

  const completed = data.completed_at
    ? new Date(data.completed_at).toLocaleString()
    : "—";

  const duration =
    data.started_at && data.completed_at
      ? Math.round(
          (new Date(data.completed_at) -
           new Date(data.started_at)) / 1000
        ) + " sec"
      : "—";

  const text =
    data.output?.raw_output
      ? data.output.raw_output.replace(/\\n/g, "\n")
      : "No output";

  body.innerHTML = `
    <label>Status:</label> ${data.status}
    <label>Started At:</label> ${started}
    <label>Completed At:</label> ${completed}
    <label>Duration:</label> ${duration}
    <label>Output:</label>
    <textarea id="step-textarea-${step}" readonly>${text}</textarea>
  `;
}

/* ================= SSE ================= */

function attachSSE() {
  if (evtSource) evtSource.close();
  evtSource = new EventSource(`${API}/events/${jobId}`);
  evtSource.onmessage = () => fetchStatus();
}
</script>

</body>
</html>
