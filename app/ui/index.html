<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    button {
      padding: 8px 14px;
      margin-top: 10px;
    }

    .step {
      padding: 8px;
      margin: 6px 0;
      border-radius: 4px;
      font-size: 14px;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    .summary {
      margin-top: 12px;
      padding: 10px;
      font-weight: bold;
      background: #e3f2fd;
      border-radius: 4px;
    }

    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>

<body>

<h1>SDLC AI</h1>

<h3>Product Idea</h3>
<textarea id="idea"></textarea>
<br />
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="status"></div>

<h3>Steps</h3>
<div id="steps"></div>

<div id="workflowSummary" class="summary" style="display:none;"></div>

<h3>Result</h3>
<pre id="result"></pre>

<script>
let jobId = null;
let poller = null;

// ⏱ Per-step timing store
const stepTimings = {};
let workflowStartedAt = null;
let workflowEndedAt = null;

/* ---------------- UTILITIES ---------------- */

function formatTime(date) {
  return date.toLocaleString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
}

function formatDuration(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${minutes}m ${seconds}s`;
}

/* ---------------- START JOB ---------------- */

function startJob() {
  const idea = document.getElementById("idea").value;

  jobId = null;
  workflowStartedAt = null;
  workflowEndedAt = null;

  for (const k in stepTimings) delete stepTimings[k];

  document.getElementById("status").innerText = "";
  document.getElementById("steps").innerHTML = "";
  document.getElementById("result").innerText = "";
  document.getElementById("workflowSummary").style.display = "none";

  fetch(`/v1/start?product_idea=${encodeURIComponent(idea)}`, {
    method: "POST"
  })
    .then(r => r.json())
    .then(data => {
      jobId = data.job_id;
      document.getElementById("status").innerText =
        "Job started: " + jobId;
      startPolling();
    });
}

/* ---------------- POLLING ---------------- */

function startPolling() {
  if (poller) clearInterval(poller);
  poller = setInterval(fetchStatus, 2000);
}

function fetchStatus() {
  if (!jobId) return;

  fetch(`/v1/status/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("status").innerText =
        `Status: ${data.status} | Current step: ${data.current_step}`;

      if (data.status === "running" && !workflowStartedAt) {
        workflowStartedAt = new Date();
      }

      renderSteps(data.steps);

      if (
        (data.status === "completed" || data.status === "failed") &&
        !workflowEndedAt
      ) {
        workflowEndedAt = new Date();
        renderWorkflowSummary();
        clearInterval(poller);

        if (data.status === "completed") {
          fetchResult();
        }
      }
    });
}

/* ---------------- STEP RENDER ---------------- */

function renderSteps(steps) {
  const stepsDiv = document.getElementById("steps");
  stepsDiv.innerHTML = "";

  const now = new Date();

  for (const [step, state] of Object.entries(steps)) {
    if (!stepTimings[step]) {
      stepTimings[step] = {
        startedAt: null,
        endedAt: null
      };
    }

    const timing = stepTimings[step];

    if (state === "running" && !timing.startedAt) {
      timing.startedAt = now;
    }

    if (
      (state === "completed" || state === "failed") &&
      timing.startedAt &&
      !timing.endedAt
    ) {
      timing.endedAt = now;
    }

    const div = document.createElement("div");
    div.className = `step ${state}`;

    let text = `${step}: ${state}`;

    if (timing.startedAt) {
      text += ` — started running at ${formatTime(timing.startedAt)}`;
    }

    if (timing.endedAt) {
      const duration = formatDuration(
        timing.endedAt - timing.startedAt
      );
      text += ` → ${state} at ${formatTime(timing.endedAt)} (${duration})`;
    }

    div.innerText = text;
    stepsDiv.appendChild(div);
  }
}

/* ---------------- WORKFLOW SUMMARY ---------------- */

function renderWorkflowSummary() {
  if (!workflowStartedAt || !workflowEndedAt) return;

  const summaryDiv = document.getElementById("workflowSummary");
  const totalDuration = formatDuration(
    workflowEndedAt - workflowStartedAt
  );

  summaryDiv.innerText = `Total workflow time: ${totalDuration}`;
  summaryDiv.style.display = "block";
}

/* ---------------- RESULT ---------------- */

function fetchResult() {
  fetch(`/v1/result/${jobId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("result").innerText =
        JSON.stringify(data, null, 2);
    });
}
</script>

</body>
</html>
