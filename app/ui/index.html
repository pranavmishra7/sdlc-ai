<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SDLC AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
    }

    textarea#idea {
      width: 100%;
      height: 80px;
    }

    .step {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
    }

    .pending { background: #eee; }
    .running { background: #fff3cd; }
    .completed { background: #d4edda; }
    .failed { background: #f8d7da; }

    .header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      font-weight: bold;
    }

    .body {
      display: none;
      margin-top: 10px;
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
    }

    .body label {
      display: block;
      margin-top: 6px;
      color: #9cdcfe;
      font-weight: bold;
    }

    .body textarea {
      width: 100%;
      min-height: 180px;
      background: #000;
      color: #0f0;
      border: 1px solid #444;
      padding: 10px;
      white-space: pre-wrap;
      resize: vertical;
    }
  </style>
</head>

<body>

<h2>SDLC AI</h2>

<textarea id="idea">Mobile app for financial investments</textarea><br><br>
<button onclick="startJob()">Start Job</button>

<h3>Status</h3>
<div id="status">Idle</div>

<h3>Workflow</h3>
<div id="steps"></div>

<script>
const API = "/api/workflows";

let jobId = null;
let poller = null;

/* internal UI state */
const stepCreated = {};
const stepExpanded = {};
const stepDataCache = {};

const LABELS = {
  intake: "Problem Statement",
  scope: "Scope Definition",
  requirements: "Requirements Breakdown",
  architecture: "Architecture Design",
  estimation: "Effort Estimation",
  risk: "Risk Analysis",
  sow: "Statement of Work"
};

/* ---------------- START JOB ---------------- */

function startJob() {
  fetch(`${API}/start`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ product_idea: idea.value })
  })
  .then(r => r.json())
  .then(d => {
    jobId = d.job_id;
    document.getElementById("status").innerText =
      `Job started (${jobId})`;

    fetchStatus(); // immediate render

    if (poller) clearInterval(poller);
    poller = setInterval(fetchStatus, 3000);
  });
}

/* ---------------- STATUS ---------------- */

function fetchStatus() {
  fetch(`${API}/${jobId}/status`)
    .then(r => r.json())
    .then(updateUI);
}

function updateUI(data) {
  const statusEl = document.getElementById("status");

  statusEl.innerText =
    data.current_step === "completed"
      ? "Workflow completed ✅"
      : "Current step: " + LABELS[data.current_step];

  for (const step in data.steps) {
    if (!stepCreated[step]) createStep(step);
    updateStepState(step, data.steps[step]);
  }

  if (data.current_step === "completed" && poller) {
    clearInterval(poller);
    poller = null;
  }
}

/* ---------------- STEP CREATION ---------------- */

function createStep(step) {
  const stepsContainer = document.getElementById("steps");

  const stepDiv = document.createElement("div");
  stepDiv.id = `step-${step}`;
  stepDiv.className = "step pending";

  const header = document.createElement("div");
  header.className = "header";
  header.innerHTML = `
    <span>${LABELS[step]}</span>
    <span id="state-${step}">pending</span>
  `;

  const body = document.createElement("div");
  body.className = "body";
  body.id = `body-${step}`;

  header.onclick = () => {
    stepExpanded[step] = !stepExpanded[step];
    body.style.display = stepExpanded[step] ? "block" : "none";

    if (stepExpanded[step] && !stepDataCache[step]) {
      fetchStep(step);
    }
  };

  stepDiv.appendChild(header);
  stepDiv.appendChild(body);
  stepsContainer.appendChild(stepDiv);

  stepCreated[step] = true;
}

/* ---------------- STEP STATE ---------------- */

function updateStepState(step, state) {
  const stepDiv = document.getElementById(`step-${step}`);
  const stateSpan = document.getElementById(`state-${step}`);

  if (!stepDiv || !stateSpan) return;

  stepDiv.className = `step ${state}`;
  stateSpan.innerText = state;
}

/* ---------------- STEP DATA ---------------- */

function fetchStep(step) {
  fetch(`${API}/${jobId}/steps/${step}`)
    .then(r => r.json())
    .then(res => {
      stepDataCache[step] = res;
      renderStep(step);
    });
}

function renderStep(step) {
  const body = document.getElementById(`body-${step}`);
  const res = stepDataCache[step];
  if (!body || !res) return;

  const d = res.data || {};

  const output =
    d.output?.raw_output
      ? d.output.raw_output.replace(/\\n/g, "\n")
      : "No output";

  body.innerHTML = `
    <label>Status</label> ${d.status || "—"}
    <label>Started</label> ${d.started_at || "—"}
    <label>Completed</label> ${d.completed_at || "—"}
    <label>Output</label>
    <textarea readonly>${output}</textarea>
  `;
}
</script>

</body>
</html>
